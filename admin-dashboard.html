<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="assets/admin-style.css">
  <style>
    /* Additional Dashboard Styles */
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .stat-label {
      color: #718096;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1a202c;
    }
    
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1a202c;
    }
    
    .user-table, .logs-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .user-table th, .logs-table th {
      text-align: left;
      padding: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.875rem;
    }
    
    .user-table td, .logs-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.875rem;
    }
    
    .user-table tr:hover, .logs-table tr:hover {
      background: #f7fafc;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .status-active {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .status-inactive {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.8125rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s;
    }
    
    .btn-sm svg {
      width: 14px;
      height: 14px;
    }
    
    .btn-edit {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .btn-edit:hover {
      background: #90cdf4;
    }
    
    .btn-delete {
      background: #fed7d7;
      color: #c53030;
    }
    
    .btn-delete:hover {
      background: #fc8181;
    }
    
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .filter-bar input, .filter-bar select {
      padding: 0.5rem 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    
    .code-display {
      font-family: monospace;
      background: #f7fafc;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8125rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="admin-header">
    <div class="header-content">
      <h1>ðŸ“Š Admin Dashboard</h1>
      <div class="header-actions">
        <button id="refresh-btn" class="header-btn">
          <i data-lucide="refresh-cw"></i> Refresh
        </button>
        <button id="logout-btn" class="header-btn logout">
          <i data-lucide="log-out"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: #bee3f8; color: #2c5282;">
          <i data-lucide="users"></i>
        </div>
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="stat-total-users">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: #c6f6d5; color: #22543d;">
          <i data-lucide="user-check"></i>
        </div>
        <div class="stat-label">Active Users</div>
        <div class="stat-value" id="stat-active-users">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: #fef5e7; color: #975a16;">
          <i data-lucide="activity"></i>
        </div>
        <div class="stat-label">Total Accesses</div>
        <div class="stat-value" id="stat-total-accesses">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background: #fad7e4; color: #97266d;">
          <i data-lucide="trending-up"></i>
        </div>
        <div class="stat-label">Last 7 Days</div>
        <div class="stat-value" id="stat-recent-accesses">0</div>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">User Management</h2>
        <button id="add-user-btn" class="btn-primary">
          <i data-lucide="user-plus"></i> Add New User
        </button>
      </div>
      
      <div class="filter-bar">
        <input type="text" id="search-users" placeholder="Search users...">
        <select id="filter-status">
          <option value="all">All Status</option>
          <option value="active">Active Only</option>
          <option value="inactive">Inactive Only</option>
        </select>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="user-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Access Code</th>
              <th>Status</th>
              <th>Last Access</th>
              <th>Devices</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
            <tr>
              <td colspan="7" style="text-align: center; padding: 2rem; color: #a0aec0;">
                Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Access Logs Section -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Access Logs</h2>
        <button id="export-logs-btn" class="btn-secondary">
          <i data-lucide="download"></i> Export CSV
        </button>
      </div>
      
      <div class="filter-bar">
        <input type="text" id="search-logs" placeholder="Search logs...">
        <select id="filter-gallery">
          <option value="all">All Galleries</option>
        </select>
        <input type="date" id="filter-date-from" placeholder="From date">
        <input type="date" id="filter-date-to" placeholder="To date">
      </div>
      
      <div style="overflow-x: auto;">
        <table class="logs-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Gallery</th>
              <th>Timestamp</th>
              <th>Device</th>
              <th>Browser</th>
            </tr>
          </thead>
          <tbody id="logs-table-body">
            <tr>
              <td colspan="5" style="text-align: center; padding: 2rem; color: #a0aec0;">
                Loading access logs...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="text-align: center; margin-top: 1rem;">
        <button id="load-more-logs" class="btn-secondary" style="display: none;">
          Load More
        </button>
      </div>
    </div>

  </div>

  <!-- Add/Edit User Modal -->
  <div id="user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Add New User</h3>
        <button class="modal-close" id="close-user-modal">
          <i data-lucide="x"></i>
        </button>
      </div>
      <form id="user-form">
        <input type="hidden" id="user-id">
        
        <div class="form-group">
          <label for="user-full-name">Full Name *</label>
          <input type="text" id="user-full-name" required>
        </div>
        
        <div class="form-group">
          <label for="user-email">Email (Optional)</label>
          <input type="email" id="user-email">
        </div>
        
        <div class="form-group">
          <label for="user-access-code">Access Code *</label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="text" id="user-access-code" required style="flex: 1;">
            <button type="button" id="generate-code-btn" class="btn-secondary">
              Generate
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="user-notes">Notes (Optional)</label>
          <textarea id="user-notes" rows="2"></textarea>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="user-is-active" checked>
            Active
          </label>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn-primary">
            <i data-lucide="save"></i> Save User
          </button>
          <button type="button" id="cancel-user-modal" class="btn-secondary">
            <i data-lucide="x"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="assets/supabase-config.js"></script>
  <script src="assets/auth-utils.js"></script>
  <script>
    // Check admin authentication
    if (!isAdminLoggedIn()) {
      window.location.href = 'admin-auth.html';
    }
    
    lucide.createIcons();
    
    let currentUsers = [];
    let currentLogs = [];
    let logsOffset = 0;
    const LOGS_LIMIT = 50;
    
    // Load dashboard data
    async function loadDashboard() {
      await Promise.all([
        loadStatistics(),
        loadUsers(),
        loadAccessLogs()
      ]);
    }
    
    // Load statistics
    async function loadStatistics() {
      try {
        // Total users
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('id, is_active, last_access');
        
        if (!usersError && users) {
          document.getElementById('stat-total-users').textContent = users.length;
          document.getElementById('stat-active-users').textContent = 
            users.filter(u => u.is_active).length;
        }
        
        // Total accesses
        const { count: totalAccesses } = await supabase
          .from('access_logs')
          .select('*', { count: 'exact', head: true });
        
        document.getElementById('stat-total-accesses').textContent = totalAccesses || 0;
        
        // Recent accesses (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        
        const { count: recentAccesses } = await supabase
          .from('access_logs')
          .select('*', { count: 'exact', head: true })
          .gte('accessed_at', sevenDaysAgo.toISOString());
        
        document.getElementById('stat-recent-accesses').textContent = recentAccesses || 0;
        
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }
    
    // Load users
    async function loadUsers() {
      try {
        const { data: users, error } = await supabase
          .from('users')
          .select(`
            *,
            devices(count),
            access_logs(count)
          `)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        currentUsers = users || [];
        renderUsers(currentUsers);
        
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-table-body').innerHTML = `
          <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #e53e3e;">
            Error loading users
          </td></tr>
        `;
      }
    }
    
    // Render users table
    function renderUsers(users) {
      const tbody = document.getElementById('users-table-body');
      
      if (users.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #a0aec0;">
            No users found
          </td></tr>
        `;
        return;
      }
      
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${escapeHtml(user.full_name)}</td>
          <td>${escapeHtml(user.email || '-')}</td>
          <td><span class="code-display">${escapeHtml(user.access_code)}</span></td>
          <td>
            <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
              ${user.is_active ? 'Active' : 'Inactive'}
            </span>
          </td>
          <td>${formatRelativeTime(user.last_access)}</td>
          <td>${user.devices?.[0]?.count || 0}</td>
          <td>
            <div class="table-actions">
              <button class="btn-sm toggle-status" data-id="${user.id}" data-active="${user.is_active}">
                <i data-lucide="${user.is_active ? 'eye-off' : 'eye'}"></i>
              </button>
              <button class="btn-sm btn-edit edit-user" data-id="${user.id}">
                <i data-lucide="edit"></i>
              </button>
              <button class="btn-sm btn-delete delete-user" data-id="${user.id}">
                <i data-lucide="trash-2"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      
      lucide.createIcons();
      
      // Attach event listeners
      document.querySelectorAll('.toggle-status').forEach(btn => {
        btn.addEventListener('click', () => toggleUserStatus(btn.dataset.id, btn.dataset.active === 'true'));
      });
      
      document.querySelectorAll('.edit-user').forEach(btn => {
        btn.addEventListener('click', () => editUser(btn.dataset.id));
      });
      
      document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', () => deleteUser(btn.dataset.id));
      });
    }
    
    // Load access logs
    async function loadAccessLogs(offset = 0) {
      try {
        const { data: logs, error } = await supabase
          .from('access_logs')
          .select(`
            *,
            users(full_name)
          `)
          .order('accessed_at', { ascending: false })
          .range(offset, offset + LOGS_LIMIT - 1);
        
        if (error) throw error;
        
        if (offset === 0) {
          currentLogs = logs || [];
        } else {
          currentLogs = [...currentLogs, ...(logs || [])];
        }
        
        renderLogs(currentLogs);
        
        // Show/hide load more button
        document.getElementById('load-more-logs').style.display = 
          logs && logs.length === LOGS_LIMIT ? 'inline-block' : 'none';
        
        logsOffset = offset + LOGS_LIMIT;
        
        // Populate gallery filter
        populateGalleryFilter();
        
      } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logs-table-body').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #e53e3e;">
            Error loading access logs
          </td></tr>
        `;
      }
    }
    
    // Render logs table
    function renderLogs(logs) {
      const tbody = document.getElementById('logs-table-body');
      
      if (logs.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #a0aec0;">
            No access logs found
          </td></tr>
        `;
        return;
      }
      
      tbody.innerHTML = logs.map(log => {
        const deviceInfo = log.device_info || {};
        return `
          <tr>
            <td>${escapeHtml(log.users?.full_name || 'Unknown')}</td>
            <td>${escapeHtml(log.gallery_name || log.gallery_id)}</td>
            <td>${formatDate(log.accessed_at)}</td>
            <td>${escapeHtml(deviceInfo.deviceType || 'Unknown')}</td>
            <td>${escapeHtml(deviceInfo.browser || 'Unknown')}</td>
          </tr>
        `;
      }).join('');
    }
    
    // Populate gallery filter dropdown
    function populateGalleryFilter() {
      const galleries = [...new Set(currentLogs.map(log => log.gallery_name).filter(Boolean))];
      const select = document.getElementById('filter-gallery');
      
      const currentValue = select.value;
      select.innerHTML = '<option value="all">All Galleries</option>' +
        galleries.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
      select.value = currentValue;
    }
    
    // Toggle user status
    async function toggleUserStatus(userId, currentStatus) {
      try {
        const { error } = await supabase
          .from('users')
          .update({ is_active: !currentStatus })
          .eq('id', userId);
        
        if (error) throw error;
        
        showToast(`User ${currentStatus ? 'disabled' : 'enabled'} successfully`, 'success');
        loadDashboard();
        
      } catch (error) {
        console.error('Error toggling user status:', error);
        showToast('Error updating user status', 'error');
      }
    }
    
    // Edit user
    async function editUser(userId) {
      const user = currentUsers.find(u => u.id === userId);
      if (!user) return;
      
      document.getElementById('modal-title').textContent = 'Edit User';
      document.getElementById('user-id').value = user.id;
      document.getElementById('user-full-name').value = user.full_name;
      document.getElementById('user-email').value = user.email || '';
      document.getElementById('user-access-code').value = user.access_code;
      document.getElementById('user-notes').value = user.notes || '';
      document.getElementById('user-is-active').checked = user.is_active;
      
      document.getElementById('user-modal').classList.add('show');
      lucide.createIcons();
    }
    
    // Delete user
    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }
      
      try {
        const { error } = await supabase
          .from('users')
          .delete()
          .eq('id', userId);
        
        if (error) throw error;
        
        showToast('User deleted successfully', 'success');
        loadDashboard();
        
      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Error deleting user', 'error');
      }
    }
    
    // Add user modal handlers
    document.getElementById('add-user-btn').addEventListener('click', () => {
      document.getElementById('modal-title').textContent = 'Add New User';
      document.getElementById('user-form').reset();
      document.getElementById('user-id').value = '';
      document.getElementById('user-is-active').checked = true;
      document.getElementById('user-modal').classList.add('show');
      lucide.createIcons();
    });
    
    document.getElementById('close-user-modal').addEventListener('click', closeUserModal);
    document.getElementById('cancel-user-modal').addEventListener('click', closeUserModal);
    
    function closeUserModal() {
      document.getElementById('user-modal').classList.remove('show');
    }
    
    // Generate access code
    document.getElementById('generate-code-btn').addEventListener('click', () => {
      document.getElementById('user-access-code').value = generateAccessCode();
    });
    
    // Submit user form
    document.getElementById('user-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userId = document.getElementById('user-id').value;
      const userData = {
        full_name: document.getElementById('user-full-name').value,
        email: document.getElementById('user-email').value || null,
        access_code: document.getElementById('user-access-code').value,
        notes: document.getElementById('user-notes').value || null,
        is_active: document.getElementById('user-is-active').checked
      };
      
      try {
        if (userId) {
          // Update existing user
          const { error } = await supabase
            .from('users')
            .update(userData)
            .eq('id', userId);
          
          if (error) throw error;
          showToast('User updated successfully', 'success');
        } else {
          // Create new user
          const { error } = await supabase
            .from('users')
            .insert(userData);
          
          if (error) throw error;
          showToast('User created successfully', 'success');
        }
        
        closeUserModal();
        loadDashboard();
        
      } catch (error) {
        console.error('Error saving user:', error);
        showToast(error.message || 'Error saving user', 'error');
      }
    });
    
    // Filter users
    document.getElementById('search-users').addEventListener('input', filterUsers);
    document.getElementById('filter-status').addEventListener('change', filterUsers);
    
    function filterUsers() {
      const search = document.getElementById('search-users').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      
      let filtered = currentUsers;
      
      if (search) {
        filtered = filtered.filter(u => 
          u.full_name.toLowerCase().includes(search) ||
          (u.email || '').toLowerCase().includes(search) ||
          u.access_code.toLowerCase().includes(search)
        );
      }
      
      if (status !== 'all') {
        filtered = filtered.filter(u => 
          status === 'active' ? u.is_active : !u.is_active
        );
      }
      
      renderUsers(filtered);
    }
    
    // Filter logs
    document.getElementById('search-logs').addEventListener('input', filterLogs);
    document.getElementById('filter-gallery').addEventListener('change', filterLogs);
    document.getElementById('filter-date-from').addEventListener('change', filterLogs);
    document.getElementById('filter-date-to').addEventListener('change', filterLogs);
    
    function filterLogs() {
      const search = document.getElementById('search-logs').value.toLowerCase();
      const gallery = document.getElementById('filter-gallery').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;
      
      let filtered = currentLogs;
      
      if (search) {
        filtered = filtered.filter(log => 
          (log.users?.full_name || '').toLowerCase().includes(search) ||
          (log.gallery_name || '').toLowerCase().includes(search)
        );
      }
      
      if (gallery !== 'all') {
        filtered = filtered.filter(log => log.gallery_name === gallery);
      }
      
      if (dateFrom) {
        const fromDate = new Date(dateFrom);
        filtered = filtered.filter(log => new Date(log.accessed_at) >= fromDate);
      }
      
      if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59);
        filtered = filtered.filter(log => new Date(log.accessed_at) <= toDate);
      }
      
      renderLogs(filtered);
    }
    
    // Export logs to CSV
    document.getElementById('export-logs-btn').addEventListener('click', () => {
      const csv = [
        ['User', 'Gallery', 'Timestamp', 'Device Type', 'Browser', 'OS'].join(','),
        ...currentLogs.map(log => {
          const deviceInfo = log.device_info || {};
          return [
            log.users?.full_name || 'Unknown',
            log.gallery_name || log.gallery_id,
            log.accessed_at,
            deviceInfo.deviceType || 'Unknown',
            deviceInfo.browser || 'Unknown',
            deviceInfo.os || 'Unknown'
          ].map(v => `"${v}"`).join(',');
        })
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `access-logs-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Access logs exported successfully', 'success');
    });
    
    // Load more logs
    document.getElementById('load-more-logs').addEventListener('click', () => {
      loadAccessLogs(logsOffset);
    });
    
    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', () => {
      logsOffset = 0;
      loadDashboard();
      showToast('Dashboard refreshed', 'success');
    });
    
    // Logout button
    document.getElementById('logout-btn').addEventListener('click', adminLogout);
    
    // Helper function
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize dashboard
    loadDashboard();
  </script>
</body>
</html>
